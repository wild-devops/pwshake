templates:
  dotnet:
    command:
    options: --version
    powershell: |
      "dotnet $($step.command) $($step.options)" | Cmd-Shell
  msbuild:
    project: /version
    targets:
    properties:
    options:
    powershell: |
      $cmd = if (${is-Linux}) {'dotnet msbuild'} else {'msbuild'}
      if ($step.msbuild) {
        $cmd += " $($step.msbuild)"
      } elseif ($step.project) {
        $cmd += " $($step.project)"
      }
      if ($step.targets) {
        foreach ($target in $step.targets) {
          $cmd += " /t:$target"
        }
      }
      if ($step.properties) {
        foreach ($property in $step.properties) {
          $cmd += " /p:$property"
        }
      }
      if ($step.options) {
        foreach ($option in $step.options) {
          $cmd += " $option"
        }
      }
      $cmd | Cmd-Shell

  transform_xml_file:
    path:
    appends:
    updates:
    removes:
    powershell: |
      $path = $step.path
      $appends = $step.appends
      $updates = $step.updates
      $removes = $step.removes
      Write-Host "Transforming file '$(Resolve-Path $path)'"
      $xml = [xml](Get-Content (Resolve-Path $path) -Raw)
      if ($appends) {
        foreach ($key in $appends.Keys) {
          foreach ($node in $xml.SelectNodes($key)) {
            Write-Host "Appending xml '$($appends[$key])' to node '$key'"
            $node.InnerXml += $appends[$key]
          }
        }
      }
      if ($updates) {
        foreach ($key in $updates.Keys) {
          foreach ($node in $xml.SelectNodes($key)) {
            Write-Host "Updating node '$key' with value '$($updates[$key])'"
            if ($node.NodeType -eq 'Element') {
              $node.InnerXml = $updates[$key]
            } else {
              $node.Value = $updates[$key]
            }
          }
        }
      }
      if ($removes) {
        foreach ($key in $removes.Keys) {
          foreach ($node in $xml.SelectNodes($key)) {
            Write-Host "Removing node '$key'"
            $node | ForEach-Object { $_.ParentNode.RemoveChild($_) } | Out-Null
          }
        }
      }
      $xml.Save((Resolve-Path $path))
